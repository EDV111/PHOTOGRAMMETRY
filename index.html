<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>3D Model Viewer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #23272A;
            color: #fff;
            font-family: Arial, Helvetica, sans-serif;
            font-size: 14px;
            line-height: 1.5;
        }

        #container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            height: 400px;
            border-radius: 4px;
            box-shadow: 0 0 16px rgba(0,0,0,0.4);
            overflow: hidden;
        }

        #drop-area {
            position: relative;
            width: 100%;
            height: 100%;
            border: 2px dashed #8c8c8c;
            border-radius: 4px;
            text-align: center;
            box-sizing: border-box;
            padding-top: 32px;
        }

        #drop-area.highlight {
            border-color: #00c1d5;
            background-color: rgba(0,193,213,0.1);
        }

        #drop-area p {
            margin: 0;
            font-size: 16px;
            font-weight: bold;
        }

        #loading-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0%;
            height: 4px;
            background-color: #00c1d5;
            transition: width 0.4s ease-in-out;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="drop-area">
            <p>Drag and drop your 3D model file here</p>
        </div>
        <div id="loading-bar"></div>
    </div>

    <script src="https://cesium.com/downloads/cesiumjs/releases/1.85/Build/Cesium/Cesium.js"></script>
    <script>
        const viewer = new Cesium.Viewer("container", {
            shouldAnimate: true,
            terrainProvider: Cesium.createWorldTerrain()
        });

        const dropArea = document.getElementById("drop-area");
        const loadingBar = document.getElementById("loading-bar");

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false)
        })

        function preventDefaults(e) {
            e.preventDefault()
            e.stopPropagation()
        }

        dropArea.addEventListener('dragenter', highlight, false)
        dropArea.addEventListener('dragover', highlight, false)
        dropArea.addEventListener('dragleave', unhighlight, false)
        dropArea.addEventListener('drop', handleDrop, false)

        function highlight(e) {
            dropArea.classList.add('highlight')
        }

        function unhighlight(e) {
            dropArea.classList.remove('highlight')
        }

        function handleDrop(e) {
            const dt = e.dataTransfer
            const files = dt.files

            handleFiles(files)
        }

        function handleFiles(files) {
            files = [...files]
            const file = files[0]
            const fileName = file.name
            const fileSize = file.size
            const fileType = file.type

            const validExtensions = ['glb', 'gltf']
            const isValidFileType = validExtensions.some(ext => fileName.toLowerCase().endsWith(ext))

                        if (!isValidFileType) {
                alert('Invalid file type. Please upload a GLB or GLTF file.')
                return
            }

            const formData = new FormData()
            formData.append('model', file)

            const xhr = new XMLHttpRequest()
            xhr.open('POST', '/api/process-model', true)

            xhr.upload.addEventListener('progress', e => {
                const percentComplete = (e.loaded / e.total) * 100
                loadingBar.style.width = percentComplete + '%'
            })

            xhr.addEventListener('load', e => {
                loadingBar.style.width = '100%'
                setTimeout(() => {
                    dropArea.classList.remove('highlight')
                    loadingBar.style.width = '0%'
                }, 1000)

                const gltfUrl = JSON.parse(xhr.responseText).gltfUrl
                const modelMatrix = Cesium.Transforms.eastNorthUpToFixedFrame(
                    Cesium.Cartesian3.fromDegrees(-75.62898254394531, 40.02804946899414, 100.0)
                )

                const entity = viewer.entities.add({
                    name: fileName,
                    position: Cesium.Cartesian3.fromDegrees(-75.62898254394531, 40.02804946899414, 100.0),
                    model: {
                        uri: gltfUrl,
                        scale: 1.0,
                        minimumPixelSize: 128,
                        maximumScale: 20000,
                        modelMatrix: modelMatrix,
                    },
                })

                viewer.zoomTo(entity)
            })

            xhr.send(formData)
        }
    </script>
</body>
</html>


