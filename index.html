<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Test Website</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
          integrity="sha384-ChfqqxuZUCnJSK3gBtuOyHlvxDmjM2+5TcSLz9/BeVRMMXQaBtMATP0mp7I5U1jQ"
          crossorigin="anonymous">
    <style>
      #dropzone {
        border: 2px dashed gray;
        padding: 1rem;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="container my-4">
      <h1>Test Website</h1>
      <hr>
      <div class="row">
        <div class="col-md-6">
          <div id="dropzone" class="mb-4">Drop a GLP file here to view its contents</div>
          <div id="progress" class="progress mb-4" style="display:none;">
            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">Uploading...</div>
          </div>
        </div>
        <div class="col-md-6">
          <canvas id="preview"></canvas>
        </div>
      </div>
      <hr>
    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
            integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
            crossorigin="anonymous"></script>
    <script>
      $(function () {
        // Set up the dropzone element to handle file drops
        var dropzone = $('#dropzone');
        dropzone.on('dragover', function (evt) {
          evt.preventDefault();
          dropzone.addClass('border-primary');
        });
        dropzone.on('dragleave', function (evt) {
          evt.preventDefault();
          dropzone.removeClass('border-primary');
        });
        dropzone.on('drop', function (evt) {
          evt.preventDefault();
          dropzone.removeClass('border-primary');
          var file = evt.originalEvent.dataTransfer.files[0];
          if (file.type === 'application/octet-stream') {
            // Show the progress bar and start uploading the file
            var progress = $('#progress');
            progress.show();
            var progressBar = $('#progress-bar');
            progressBar.css('width', '0%');
            var formData = new FormData();
            formData.append('file', file);
            $.ajax({
              url: 'process_glp.php',
              type: 'POST',
              data: formData,
              contentType: false,
              processData: false,
                            xhr: function () {
                var xhr = $.ajaxSettings.xhr();
                if (xhr.upload) {
                  xhr.upload.addEventListener('progress', function (evt) {
                    if (evt.lengthComputable) {
                      var percent = (evt.loaded / evt.total) * 100;
                      progressBar.css('width', percent + '%');
                    }
                  }, false);
                }
                return xhr;
              },
              success: function (response) {
                // Hide the progress bar
                progress.hide();

                // Parse the GLP file and extract the relevant information
                var data = new DataView(response);
                var numPoints = data.getInt32(0, true);
                var xCoords = new Float32Array(data.buffer, 4, numPoints);
                var yCoords = new Float32Array(data.buffer, 4 + numPoints * 4, numPoints);

                // Create a new canvas to display the preview and set its dimensions
                var canvas = $('#preview')[0];
                canvas.width = 600;
                canvas.height = 400;

                // Get the canvas context and set the line style
                var ctx = canvas.getContext('2d');
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 1;

                // Draw the path on the canvas
                ctx.beginPath();
                ctx.moveTo(xCoords[0], yCoords[0]);
                for (var i = 1; i < numPoints; i++) {
                  ctx.lineTo(xCoords[i], yCoords[i]);
                }
                ctx.stroke();
              },
              error: function () {
                alert('An error occurred while processing the file.');
              }
            });
          } else {
            alert('Please drop a GLP file.');
          }
        });
      });
    </script>
  </body>
</html>

