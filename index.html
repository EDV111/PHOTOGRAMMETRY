<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>GLB Viewer</title>
    <style>
      body {
        font-family: sans-serif;
      }

      #dropArea {
        border: 2px dashed #ccc;
        border-radius: 8px;
        width: 80vw;
        height: 80vh;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 24px;
        font-weight: bold;
        color: #aaa;
        cursor: pointer;
      }

      #dropArea.dragover {
        background-color: #f7f7f7;
      }

      #modelViewer {
        width: 80vw;
        height: 80vh;
        margin: 0 auto;
      }

      #loadingBar {
        width: 100%;
        height: 5px;
        background-color: #ddd;
        margin-top: 10px;
      }

      #progressBar {
        height: 100%;
        background-color: #4caf50;
      }

      #loadingText {
        margin-top: 10px;
        text-align: center;
        font-size: 14px;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div id="dropArea">Drag and drop a GLB or GLTF file here</div>
    <model-viewer id="modelViewer" camera-controls ar>
      <button slot="ar-button" id="arButton">View in AR</button>
    </model-viewer>
    <div id="loadingBar">
      <div id="progressBar"></div>
    </div>
    <div id="loadingText"></div>
    <script type="module">
      const modelViewer = document.querySelector('#modelViewer');
      const arButton = document.querySelector('#arButton');
      const loadingBar = document.querySelector('#loadingBar');
      const progressBar = document.querySelector('#progressBar');
      const loadingText = document.querySelector('#loadingText');
      const dropArea = document.querySelector('#dropArea');
      let file;
      
      const validExtensions = ['glb', 'gltf'];
      function isValidFileType(fileName) {
        return validExtensions.some(ext => fileName.toLowerCase().endsWith(ext));
      }

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      function highlight() {
        dropArea.classList.add('dragover');
      }
      
      function unhighlight() {
        dropArea.classList.remove('dragover');
      }
      
      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
      }
      
      function handleFiles(files) {
        file = files[0];
        if (isValidFileType(file.name)) {
          const reader = new FileReader();
          reader.readAsArrayBuffer(file);
          reader.onloadstart = () => {
            loadingBar.style.display = 'block';
            progressBar.style.width = '0%';
            loadingText.innerText = 'Loading...';
          };
          reader.onprogress = (event) => {
            if (event.lengthComputable) {
              const percentLoaded = Math.round((event.loaded / event.total) * 100);
              progressBar.style.width = `${percentLoaded}%`;
            }
          };
          reader.onload = (event) => {
            const arrayBuffer = reader.result;
            const blob = new Blob([arrayBuffer], { type: 'model/gltf-binary' });
            const objectURL = URL.createObjectURL(blob);
                       modelViewer.addEventListener('load', () => {
                URL.revokeObjectURL(objectURL);
                hideLoader();
                const model = modelViewer.querySelector('model');
                if (model && model.loaded) {
                    console.log('Model loaded successfully');
                } else {
                    console.log('Failed to load model');
                }
            });
        };

        const handleDrop = (e) => {
            e.preventDefault();
            e.stopPropagation();

            const dt = e.dataTransfer;
            const files = dt.files;

            if (files.length > 0) {
                const file = files[0];
                const fileName = file.name;
                const validExtensions = ['glb', 'gltf'];
                const isValidFileType = validExtensions.some(ext => fileName.toLowerCase().endsWith(ext));

                if (!isValidFileType) {
                    console.error('Invalid file type. Please provide a .glb or .gltf file');
                    return;
                }

                showLoader();

                const reader = new FileReader();
                reader.readAsArrayBuffer(file);
                reader.onload = (event) => {
                    const arrayBuffer = reader.result;
                    const blob = new Blob([arrayBuffer], { type: 'model/gltf-binary' });
                    const objectURL = URL.createObjectURL(blob);
                    modelViewer.src = objectURL;
                };
            }
        };

        const handleDragOver = (e) => {
            e.preventDefault();
            e.stopPropagation();
            e.dataTransfer.dropEffect = 'copy';
        };

        const showLoader = () => {
            loader.style.display = 'block';
        };

        const hideLoader = () => {
            loader.style.display = 'none';
        };

        dropArea.addEventListener('drop', handleDrop);
        dropArea.addEventListener('dragover', handleDragOver);
    </script>
</body>
</html>

